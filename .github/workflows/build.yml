name: Build & Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pygame pyinstaller pillow

      - name: Convert icon to icns
        run: |
          python3 << 'PYEOF'
          from PIL import Image
          import os, struct, io

          img = Image.open('resources/icons/icon.png').convert('RGBA')
          os.makedirs('icon.iconset', exist_ok=True)

          sizes = {
              'icon_16x16.png': 16, 'icon_16x16@2x.png': 32,
              'icon_32x32.png': 32, 'icon_32x32@2x.png': 64,
              'icon_128x128.png': 128, 'icon_128x128@2x.png': 256,
              'icon_256x256.png': 256, 'icon_256x256@2x.png': 512,
              'icon_512x512.png': 512, 'icon_512x512@2x.png': 1024,
          }
          for name, size in sizes.items():
              img.resize((size, size), Image.LANCZOS).save(f'icon.iconset/{name}', format='PNG')

          print("Iconset created")
          PYEOF
          iconutil -c icns icon.iconset -o resources/icons/icon.icns

      - name: Build macOS app bundle
        run: |
          pyinstaller --windowed \
            --name MEFENSTEIN \
            --icon resources/icons/icon.icns \
            --add-data "resources:resources" \
            --add-data "src:src" \
            --add-data "settings.py:." \
            main.py

      - name: Create DMG
        run: |
          brew install create-dmg
          create-dmg \
            --volname "MEFENSTEIN" \
            --volicon "resources/icons/icon.icns" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 128 \
            --icon "MEFENSTEIN.app" 150 180 \
            --hide-extension "MEFENSTEIN.app" \
            --app-drop-link 450 180 \
            "MEFENSTEIN-macOS.dmg" \
            "dist/"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: MEFENSTEIN-macOS
          path: MEFENSTEIN-macOS.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pygame pyinstaller pillow

      - name: Build Windows exe
        run: |
          pyinstaller --onefile --windowed `
            --name MEFENSTEIN `
            --icon resources/icons/icon.ico `
            --add-data "resources;resources" `
            --add-data "src;src" `
            --add-data "settings.py;." `
            main.py

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: MEFENSTEIN-Windows
          path: dist/MEFENSTEIN.exe

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip libsdl2-dev libsdl2-mixer-dev libsdl2-image-dev fuse libfuse2

      - name: Install Python dependencies
        run: pip install pygame pyinstaller

      - name: Build Linux binary
        run: |
          pyinstaller --onefile \
            --name MEFENSTEIN \
            --add-data "resources:resources" \
            --add-data "src:src" \
            --add-data "settings.py:." \
            main.py

      - name: Create AppImage
        run: |
          # AppImage yapÄ±sÄ±nÄ± oluÅŸtur
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          cp dist/MEFENSTEIN AppDir/usr/bin/MEFENSTEIN
          cp resources/icons/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/mefenstein.png
          cp resources/icons/icon.png AppDir/mefenstein.png

          # .desktop dosyasÄ±
          cat > AppDir/mefenstein.desktop << 'EOF'
          [Desktop Entry]
          Name=MEFENSTEIN
          Comment=Cehennemden KaÃ§Ä±ÅŸ
          Exec=MEFENSTEIN
          Icon=mefenstein
          Type=Application
          Categories=Game;
          EOF

          # AppRun
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          exec "$HERE/usr/bin/MEFENSTEIN" "$@"
          EOF
          chmod +x AppDir/AppRun

          # appimagetool indir ve AppImage oluÅŸtur
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir MEFENSTEIN-Linux.AppImage

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: MEFENSTEIN-Linux
          path: MEFENSTEIN-Linux.AppImage

  release:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: MEFENSTEIN-macOS
          path: artifacts/macos

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: MEFENSTEIN-Windows
          path: artifacts/windows

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: MEFENSTEIN-Linux
          path: artifacts/linux

      - name: Rename artifacts
        run: |
          mv artifacts/macos/MEFENSTEIN-macOS.dmg artifacts/MEFENSTEIN-macOS.dmg
          mv artifacts/windows/MEFENSTEIN.exe artifacts/MEFENSTEIN-Windows.exe
          mv artifacts/linux/MEFENSTEIN-Linux.AppImage artifacts/MEFENSTEIN-Linux.AppImage
          chmod +x artifacts/MEFENSTEIN-Linux.AppImage

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: MEFENSTEIN ${{ github.ref_name }}
          body: |
            ## MEFENSTEIN ${{ github.ref_name }} â€” Cehennemden KaÃ§Ä±ÅŸ

            A Wolfenstein-style FPS built from scratch in Python using raycasting.

            ### Download
            | Platform | File |
            |----------|------|
            | ðŸŽ macOS | `MEFENSTEIN-macOS.dmg` â€” aÃ§, .app'i Applications'a sÃ¼rÃ¼kle |
            | ðŸªŸ Windows | `MEFENSTEIN-Windows.exe` â€” direkt Ã§alÄ±ÅŸtÄ±r |
            | ðŸ§ Linux | `MEFENSTEIN-Linux.AppImage` â€” `chmod +x` sonra Ã§ift tÄ±kla |

            > **macOS:** Ä°lk aÃ§Ä±lÄ±ÅŸta "bilinmeyen geliÅŸtirici" uyarÄ±sÄ± gelirse saÄŸ tÄ±klayÄ±p **AÃ§** seÃ§in.

            ### Controls
            | Key | Action |
            |-----|--------|
            | W A S D | Move |
            | Mouse | Look |
            | Left Click | Shoot |
            | 1 / 2 | Switch weapon |
            | F11 | Fullscreen |
            | ESC | Pause |
          files: |
            artifacts/MEFENSTEIN-macOS.dmg
            artifacts/MEFENSTEIN-Windows.exe
            artifacts/MEFENSTEIN-Linux.AppImage