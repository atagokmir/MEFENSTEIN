name: Build & Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pygame pyinstaller pillow

      - name: Convert icon to icns
        run: |
          python3 << 'PYEOF'
          from PIL import Image
          import os, struct, io

          img = Image.open('resources/icons/icon.png').convert('RGBA')
          os.makedirs('icon.iconset', exist_ok=True)

          sizes = {
              'icon_16x16.png': 16, 'icon_16x16@2x.png': 32,
              'icon_32x32.png': 32, 'icon_32x32@2x.png': 64,
              'icon_128x128.png': 128, 'icon_128x128@2x.png': 256,
              'icon_256x256.png': 256, 'icon_256x256@2x.png': 512,
              'icon_512x512.png': 512, 'icon_512x512@2x.png': 1024,
          }
          for name, size in sizes.items():
              img.resize((size, size), Image.LANCZOS).save(f'icon.iconset/{name}', format='PNG')

          print("Iconset created")
          PYEOF
          iconutil -c icns icon.iconset -o resources/icons/icon.icns

      - name: Build macOS binary
        run: |
          pyinstaller --onefile --windowed \
            --name MEFENSTEIN \
            --icon resources/icons/icon.icns \
            --add-data "resources:resources" \
            --add-data "src:src" \
            --add-data "settings.py:." \
            main.py

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: MEFENSTEIN-macOS
          path: dist/MEFENSTEIN

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pygame pyinstaller pillow

      - name: Build Windows exe
        run: |
          pyinstaller --onefile --windowed `
            --name MEFENSTEIN `
            --icon resources/icons/icon.ico `
            --add-data "resources;resources" `
            --add-data "src;src" `
            --add-data "settings.py;." `
            main.py

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: MEFENSTEIN-Windows
          path: dist/MEFENSTEIN.exe

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip libsdl2-dev libsdl2-mixer-dev libsdl2-image-dev

      - name: Install Python dependencies
        run: pip install pygame pyinstaller

      - name: Build Linux binary
        run: |
          pyinstaller --onefile \
            --name MEFENSTEIN \
            --add-data "resources:resources" \
            --add-data "src:src" \
            --add-data "settings.py:." \
            main.py

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: MEFENSTEIN-Linux
          path: dist/MEFENSTEIN

  release:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: MEFENSTEIN-macOS
          path: artifacts/macos

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: MEFENSTEIN-Windows
          path: artifacts/windows

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: MEFENSTEIN-Linux
          path: artifacts/linux

      - name: Rename artifacts
        run: |
          mv artifacts/macos/MEFENSTEIN artifacts/MEFENSTEIN-macOS
          mv artifacts/windows/MEFENSTEIN.exe artifacts/MEFENSTEIN-Windows.exe
          mv artifacts/linux/MEFENSTEIN artifacts/MEFENSTEIN-Linux
          chmod +x artifacts/MEFENSTEIN-macOS artifacts/MEFENSTEIN-Linux

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: MEFENSTEIN ${{ github.ref_name }}
          body: |
            ## MEFENSTEIN ${{ github.ref_name }} â€” Cehennemden KaÃ§Ä±ÅŸ

            A Wolfenstein-style FPS built from scratch in Python using raycasting.

            ### Download
            | Platform | File |
            |----------|------|
            | ðŸŽ macOS | `MEFENSTEIN-macOS` |
            | ðŸªŸ Windows | `MEFENSTEIN-Windows.exe` |
            | ðŸ§ Linux | `MEFENSTEIN-Linux` |

            > **macOS:** Ä°lk Ã§alÄ±ÅŸtÄ±rmada saÄŸ tÄ±klayÄ±p **AÃ§** seÃ§in.  
            > **Linux:** `chmod +x MEFENSTEIN-Linux && ./MEFENSTEIN-Linux`

            ### Controls
            | Key | Action |
            |-----|--------|
            | W A S D | Move |
            | Mouse | Look |
            | Left Click | Shoot |
            | 1 / 2 | Switch weapon |
            | F11 | Fullscreen |
            | ESC | Pause |
          files: |
            artifacts/MEFENSTEIN-macOS
            artifacts/MEFENSTEIN-Windows.exe
            artifacts/MEFENSTEIN-Linux